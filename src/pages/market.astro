---
import Layout from '../layouts/Layout.astro';
import SearchableMarketTracker from '../components/SearchableMarketTracker';
import { Radio, ExternalLink, Zap, Activity } from 'lucide-react';

// --- SERVER-SIDE NEWS FETCH ---
const GUARDIAN_KEY = process.env.GUARDIAN_API_KEY; 
const newsUrl = `https://content.guardianapis.com/search?section=business|technology&show-fields=trailText&page-size=6&api-key=${GUARDIAN_KEY}`;

let news = [];
try {
  const response = await fetch(newsUrl);
  const data = await response.json();
  news = data.response?.results || [];
} catch (e) {
  console.error("News Uplink Offline");
}
---

<Layout title="Market Intel | Intelligence Dashboard">
  <div class="fixed inset-0 z-0 bg-[#020308]">
    <div class="absolute inset-0 bg-[url('/noise.svg')] opacity-[0.03] mix-blend-overlay pointer-events-none"></div>
    <div class="absolute inset-0 bg-gradient-to-b from-blue-900/10 via-transparent to-[#020308]"></div>
  </div>

  <main class="relative z-10 w-full min-h-screen py-24 px-[8vw]">
    
    <div class="max-w-6xl mx-auto mb-20 text-right">
      <div class="flex items-center justify-end gap-2 text-blue-500 font-mono font-bold uppercase tracking-[0.4em] text-[10px] mb-4">
        <Activity size={12} class="animate-pulse" /> 
        <span>Terminal_Status: Active</span>
      </div>
      <h1 class="text-[clamp(3rem,10vw,6rem)] font-black uppercase italic tracking-tighter text-white leading-none">
        Market <span class="text-blue-500">Intelligence</span>
      </h1>
      <p class="text-white/20 font-mono uppercase tracking-[0.5em] text-[10px] mt-4 italic">
        Architected by Abhiram Â· Data Uplink: US-EAST-1
      </p>
    </div>

    <div class="max-w-3xl mx-auto mb-40">
      <SearchableMarketTracker client:only="react" />
    </div>

    <div class="max-w-6xl mx-auto">
      <div class="flex items-center justify-end gap-3 mb-12">
        <div class="h-[1px] w-24 bg-gradient-to-l from-blue-500 to-transparent"></div>
        <span class="text-[10px] font-mono uppercase tracking-[0.5em] text-blue-500 flex items-center gap-2">
          <Radio size={12} class="animate-pulse" /> Global_Briefing_Feed
        </span>
      </div>

      <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
        {news.map((item) => (
          <a href={item.webUrl} target="_blank" class="group relative p-8 rounded-[2rem] border border-white/[0.05] bg-[#050a14]/60 backdrop-blur-2xl hover:bg-[#0a1120]/90 transition-all duration-500 text-left flex flex-col justify-between h-[300px]">
            <div>
              <div class="flex justify-between items-start mb-6">
                <span class="px-3 py-1 rounded-full bg-blue-500/10 border border-blue-500/20 text-[8px] font-mono text-blue-400 uppercase tracking-widest font-bold">
                  {item.sectionName}
                </span>
                <ExternalLink size={14} class="text-white/10 group-hover:text-blue-500" />
              </div>
              <h4 class="text-lg font-black italic text-white leading-tight tracking-tighter uppercase group-hover:text-blue-400 transition-colors line-clamp-3">
                {item.webTitle}
              </h4>
            </div>
            
            <div class="mt-auto">
              <p class="text-white/20 font-mono text-[9px] uppercase tracking-wide line-clamp-2 mb-4">
                {item.fields?.trailText?.replace(/<[^>]*>?/gm, '')}
              </p>
              <div class="flex items-center gap-2 text-[8px] font-mono text-blue-500/40 uppercase tracking-widest">
                <Zap size={10} /> {new Date(item.webPublicationDate).toLocaleTimeString()} UTC
              </div>
            </div>
          </a>
        ))}
      </div>
    </div>
  </main>
</Layout>

<style is:global>
  /* FORCE SCROLLING */
  html, body {
    overflow-y: auto !important;
    height: auto !important;
    min-height: 100vh;
    background: #020308;
    scroll-behavior: smooth;
  }

  /* Custom Scrollbar for Terminal Look */
  ::-webkit-scrollbar { width: 4px; }
  ::-webkit-scrollbar-track { background: transparent; }
  ::-webkit-scrollbar-thumb { 
    background: rgba(59, 130, 246, 0.2); 
    border-radius: 10px; 
  }
</style>
