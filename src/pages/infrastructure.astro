---
import Layout from '../layouts/Layout.astro';
import EarthCanvas from '../components/EarthCanvas.tsx';
import CostMonitor from '../components/CostMonitor.astro';
import Navbar from '../components/Navbar.astro';
import { getLiveMetrics } from '../lib/aws';

// Force Server-Side Rendering for live AWS data
export const prerender = false;

// Fetch Live Telemetry from AWS CloudWatch
let liveRequests = null;
try {
  liveRequests = await getLiveMetrics();
} catch (e) {
  console.error("AWS_FETCH_ERROR", e);
}

const status = liveRequests !== null ? "ACTIVE" : "OFFLINE";
---

<Layout title="Cloud Ops | Infrastructure">
  <div class="fixed inset-0 z-0 bg-[#010206]">
    <div class="absolute inset-0 bg-[url('/noise.svg')] opacity-[0.04] mix-blend-overlay pointer-events-none"></div>
    
    <EarthCanvas client:only="react" />
    
    <div class="absolute inset-0 bg-gradient-to-b from-transparent via-[#010206]/40 to-[#010206]"></div>
  </div>

  <Navbar />

  <main class="relative z-10 w-full pt-24 sm:pt-32 pb-40 min-h-screen overflow-x-hidden">
     <div class="px-[6vw] sm:px-[8vw] max-w-[1400px] mx-auto">
        
        <div class="mb-12 flex flex-col sm:flex-row justify-between items-start sm:items-center gap-6 border-l-2 border-blue-500/40 pl-6 backdrop-blur-sm py-2">
           <div class="flex flex-col gap-1">
              <div class="flex items-center gap-3">
                 <div class={`h-2 w-2 rounded-full ${status === 'ACTIVE' ? 'bg-blue-400 animate-pulse shadow-[0_0_10px_#60a5fa]' : 'bg-red-500 shadow-[0_0_10px_#ef4444]'}`}></div>
                 <span class="text-[10px] font-mono font-black text-blue-400 tracking-[0.4em] uppercase">
                    AWS_LIVE_TELEMETRY: {status}
                 </span>
              </div>
              <p class="text-[9px] font-mono text-white/30 uppercase tracking-widest font-bold">
                PROVISIONED: US-EAST-1 (N. VIRGINIA)
              </p>
           </div>
           
           <div class="text-left sm:text-right bg-white/[0.03] px-4 py-2 rounded-xl border border-white/5 backdrop-blur-md">
              <span class="text-[9px] font-mono text-white/40 uppercase tracking-[0.3em] block mb-1">System_Clock</span>
              <p id="live-clock" class="text-sm font-mono text-blue-400 font-bold tabular-nums tracking-tighter uppercase">
                --:--:-- ET
              </p>
           </div>
        </div>

        <div class="animate-in fade-in slide-in-from-bottom-4 duration-1000">
           <CostMonitor requests={liveRequests} />
        </div>

     </div>
  </main>
</Layout>

<script is:inline>
  /**
   * Updates the system clock to America/New_York (ET)
   */
  function updateClock() {
    const clock = document.getElementById('live-clock');
    if (clock) {
      const now = new Date();
      clock.innerText = now.toLocaleTimeString('en-US', { 
        hour12: false, 
        hour: '2-digit',
        minute: '2-digit',
        second: '2-digit',
        timeZone: 'America/New_York' 
      }) + ' ET';
    }
  }

  // Refresh every second for real-time feel
  setInterval(updateClock, 1000);
  updateClock();

  /**
   * Data Persistence: Refresh from AWS API every 10 minutes
   */
  setTimeout(() => {
    // Only refresh if the user is currently viewing the page
    if (!document.hidden) {
        window.location.reload();
    }
  }, 600000);
</script>

<style is:global>
  /* 5. GLOBAL STYLES & MOBILE OVERRIDES */
  html, body {
    overflow-y: auto !important;
    height: auto !important;
    min-height: 100vh;
    background: #010206;
    scroll-behavior: smooth;
    /* Safe Area Support for iPhone 14 Pro */
    padding-bottom: env(safe-area-inset-bottom);
  }
  
  /* Prevent interaction with the 3D globe */
  canvas { pointer-events: none !important; }

  /* High-Tech Glass Scrollbar */
  ::-webkit-scrollbar { width: 4px; }
  ::-webkit-scrollbar-track { background: transparent; }
  ::-webkit-scrollbar-thumb { 
    background: rgba(96, 165, 250, 0.3); 
    border-radius: 20px; 
  }

  /* Specific Adjustments for iPhone 14 Pro & Mobile */
  @media (max-width: 430px) {
    main {
      padding-top: 5.5rem !important; /* Clears Dynamic Island */
    }
    #live-clock {
      font-size: 0.75rem;
    }
  }

  /* Tabular numbers prevent the clock from jittering */
  .tabular-nums {
    font-variant-numeric: tabular-nums;
  }
</style>