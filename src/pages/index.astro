---
import Layout from '../layouts/Layout.astro';
import EarthCanvas from '../components/EarthCanvas.tsx';
import LeetCodeCard from '../components/LeetCodeCard.tsx';
import ProjectGrid from '../components/ProjectGrid.tsx';
import LinkedInCard from '../components/LinkedInCard.tsx';
import CertificationGrid from '../components/CertificationGrid.tsx';
import Navbar from '../components/Navbar.astro';
import { Mail, Terminal, ExternalLink, Activity } from 'lucide-react';

// Required for dynamic API fetching on the homepage
export const prerender = false;
---

<Layout title="Abhiram | Portfolio">
  <div class="fixed inset-0 z-0 bg-[#030303]">
    <div class="absolute inset-0 z-10 bg-[url('/noise.svg')] opacity-[0.03] mix-blend-overlay pointer-events-none"></div>
    <EarthCanvas client:only="react" />
    <div class="absolute inset-0 z-20 bg-gradient-to-b from-transparent via-[#030303]/40 to-[#030303]"></div>
  </div>

  <Navbar />

  <main class="relative z-10 w-full">
    
    <section id="home" class="h-screen w-full flex items-center justify-end px-[5vw] py-20">
      <div class="text-right animate-fade-in w-full max-w-7xl">
        <h1 class="text-[clamp(4.5rem,15vw,12rem)] font-black tracking-tighter text-white leading-[0.8] uppercase italic">
          ABHI<br/>
          <span class="text-blue-500">ram</span>
        </h1>
        
        <div class="mt-8 border-t border-white/10 pt-8 inline-block">
          <p class="text-[clamp(1.5rem,4vw,2.5rem)] text-white font-bold tracking-tight uppercase">
            Purdue University
          </p>
          <p class="text-white/40 text-[clamp(0.8rem,1.5vw,1.2rem)] font-mono tracking-[0.2em] uppercase mt-2">
            M.S. Student in <span class="text-blue-400/80 italic">Computer Science</span>
          </p>
        </div>
      </div>
    </section>

    <section class="w-full py-10 px-[5vw] flex flex-col md:flex-row items-center justify-center gap-8 -mt-20 mb-20">
      <div class="flex items-center gap-6 px-8 py-4 rounded-full border border-white/5 bg-white/[0.02] backdrop-blur-md">
        <div class="flex h-2 w-2 relative">
          <span class="animate-ping absolute inline-flex h-full w-full rounded-full bg-blue-400 opacity-75"></span>
          <span class="relative inline-flex rounded-full h-2 w-2 bg-blue-500"></span>
        </div>
        <p class="font-mono text-[10px] md:text-xs uppercase tracking-[0.4em] text-white/50">
          Total Visitors: 
          <span id="visitor-count" class="text-blue-500 font-black ml-2 text-glow">000000</span>
        </p>
      </div>

      <div class="flex items-center gap-6 px-8 py-4 rounded-full border border-white/5 bg-white/[0.02] backdrop-blur-md">
        <Activity size={14} id="metrics-icon" class="text-white/20 transition-colors duration-500" />
        <p class="font-mono text-[10px] md:text-xs uppercase tracking-[0.4em] text-white/50">
          Live Traffic: 
          <span id="metric-requests" class="text-blue-400 font-black ml-2">---</span>
          <span id="uplink-status" class="ml-2 text-[8px] text-red-500 font-bold uppercase tracking-wider">OFFLINE</span>
        </p>
      </div>
    </section>

    <section id="leetcode" class="min-h-screen w-full flex flex-col items-center justify-center px-[5vw] bg-black/10 py-32">
        <div class="max-w-6xl w-full">
          <h2 class="text-blue-500 font-mono tracking-[0.6em] text-center text-[10px] md:text-xs uppercase mb-16">
            Problem Solving Stats
          </h2>
          <div class="backdrop-blur-xl rounded-[3rem] border border-white/5 bg-white/[0.01]">
             <LeetCodeCard client:load /> 
          </div>
        </div>
      </section>
  
      <section id="builds" class="min-h-screen w-full py-32 px-[5vw]">
        <div class="max-w-7xl mx-auto">
          <div class="flex flex-col md:flex-row justify-between items-start md:items-end mb-24 gap-12">
            <div class="max-w-xl text-left">
              <h3 class="font-mono text-blue-500 uppercase tracking-[0.6em] mb-6 text-[10px]">Project Portfolio</h3>
              <p class="text-white/30 text-xs md:text-sm font-mono leading-relaxed uppercase tracking-tighter">
                Synthesizing cloud-native architectures into fluid, data-driven interfaces.
              </p>
            </div>
            <h2 class="text-[clamp(3.5rem,10vw,7rem)] font-black italic uppercase tracking-tighter text-white leading-none">
              Key <span class="text-blue-500">Builds</span>
            </h2>
          </div>
          <ProjectGrid client:load />
        </div>
      </section>

    <section id="contact" class="min-h-[80vh] w-full py-32 px-[5vw] flex items-center justify-center">
        <div class="max-w-4xl w-full">
          <div class="flex items-center gap-4 mb-12 justify-center">
            <Terminal size={18} class="text-blue-500 animate-pulse" />
            <span class="text-[10px] md:text-xs font-mono font-black text-blue-500 uppercase tracking-[0.5em]">
              Get In Touch
            </span>
          </div>
          
          <div class="relative group p-12 md:p-20 rounded-[3.5rem] border border-white/10 bg-white/[0.02] backdrop-blur-[60px] shadow-2xl text-center transition-all hover:border-blue-500/30">
            <div class="space-y-8 relative z-10">
              <h2 class="text-5xl md:text-7xl font-black italic text-white uppercase tracking-tighter leading-none">
                Contact <span class="text-blue-500">Node</span>
              </h2>
              <div class="relative inline-block mt-8">
                <a href="mailto:mulpm01@purdue.edu" class="flex flex-col items-center gap-4 px-10 py-8 rounded-[2rem] bg-white/5 border border-white/5 hover:border-blue-500/40 transition-all duration-500">
                  <Mail size={40} class="text-blue-500 mb-2" />
                  <span class="text-xl md:text-3xl font-mono font-bold text-white tracking-widest break-all">
                    mulpm01@purdue.edu
                  </span>
                </a>
              </div>
            </div>
          </div>
        </div>
      </section>

  </main>
</Layout>

<script>
  // 1. VISITOR COUNTER LOGIC
  async function initVisitorCounter() {
    const countElement = document.getElementById('visitor-count');
    if (!countElement) return;

    try {
      const response = await fetch('/api/visitor-count');
      const data = await response.json();
      if (data.count) {
        // Custom animation function
        let start = 0;
        let end = parseInt(data.count);
        let duration = 2000;
        let startTimestamp = null;
        
        const step = (timestamp) => {
          if (!startTimestamp) startTimestamp = timestamp;
          const progress = Math.min((timestamp - startTimestamp) / duration, 1);
          countElement.innerHTML = Math.floor(progress * (end - start) + start).toString().padStart(6, '0');
          if (progress < 1) {
            window.requestAnimationFrame(step);
          }
        };
        window.requestAnimationFrame(step);
      }
    } catch (e) { console.error("Visitor fetch failed"); }
  }

  // 2. REAL-TIME METRICS LOGIC
  async function refreshMetrics() {
    const statusEl = document.getElementById('uplink-status');
    const reqEl = document.getElementById('metric-requests');
    const iconEl = document.getElementById('metrics-icon');

    try {
      // Calls your created API route
      const res = await fetch('/api/metrics');
      const data = await res.json();

      if (data && data.status === "ONLINE") {
        if (statusEl) {
          statusEl.innerText = "ACTIVE";
          statusEl.className = "ml-2 text-[8px] text-green-500 font-bold uppercase animate-pulse tracking-wider";
        }
        if (reqEl) {
            // Handles cases where data might be 0 but still online
            reqEl.innerText = (data.requests || 0).toString();
        }
        if (iconEl) {
            iconEl.classList.remove('text-white/20');
            iconEl.classList.add('text-blue-500', 'animate-pulse');
        }
      }
    } catch (err) {
      if (statusEl) {
          statusEl.innerText = "OFFLINE";
          statusEl.className = "ml-2 text-[8px] text-red-500 font-bold uppercase tracking-wider";
      }
    }
  }

  // Initialize on Load
  window.addEventListener('load', () => {
    initVisitorCounter();
    refreshMetrics();
    // Poll every 30 seconds
    setInterval(refreshMetrics, 30000);
  });
</script>

<style is:global>
  :global(html) { scroll-behavior: smooth; overflow-y: auto !important; }
  :global(body) { background-color: #030303; margin: 0; overflow-x: hidden; -webkit-font-smoothing: antialiased; }
  .text-glow { text-shadow: 0 0 30px rgba(59, 130, 246, 0.4); }
  .animate-fade-in { animation: fadeIn 1.5s ease-out forwards; }
  @keyframes fadeIn { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }
  ::-webkit-scrollbar { width: 4px; }
  ::-webkit-scrollbar-thumb { background: rgba(59, 130, 246, 0.3); border-radius: 10px; }
</style>